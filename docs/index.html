<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Factory Feed</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #eaeaea;
      --text: #000000;
      --text-secondary: #666666;
      --text-tertiary: #888888;
      --accent: #000000;
      --accent-fg: #ffffff;
      --hover: #f5f5f5;
      --selection: #e6f7ff;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --twitter-color: #1d9bf0;
      --reddit-color: #ff4500;
      --github-color: #24292f;
    }

    [data-theme="dark"] {
      --bg: #000000;
      --card-bg: #0a0a0a;
      --border: #333333;
      --text: #ffffff;
      --text-secondary: #a1a1a1;
      --text-tertiary: #666666;
      --accent: #ffffff;
      --accent-fg: #000000;
      --hover: #111111;
      --selection: #1a1a1a;
      --github-color: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Layout */
    .app-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      flex-shrink: 0;
      z-index: 20;
    }

    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      background: var(--bg);
      border-right: 1px solid var(--border);
      padding: 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .main-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      position: relative;
      background: var(--bg);
    }

    /* Sidebar Categories */
    .category-item {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.15s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .category-item:hover {
      background: var(--hover);
      color: var(--text);
    }

    .category-item.active {
      background: var(--card-bg);
      color: var(--text);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      font-weight: 600;
    }
    
    .category-item .count {
        background: var(--border);
        padding: 2px 6px;
        border-radius: 99px;
        font-size: 10px;
        min-width: 20px;
        text-align: center;
        opacity: 0.8;
    }

    /* Hide card actions as requested */
    .card-actions {
      display: none !important;
    }

    .app-logo {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-filters {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 4px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .filter-tab {
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
    }

    .filter-tab:hover {
      color: var(--text);
      background: var(--card-bg);
    }

    .filter-tab.active {
      background: var(--card-bg);
      color: var(--text);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .filter-tab .badge {
      background: var(--border);
      color: var(--text-secondary);
      font-size: 10px;
      padding: 0 4px;
      border-radius: 99px;
      min-width: 16px;
      text-align: center;
    }

    /* Category Pills */
    .category-pill {
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .category-pill:hover {
      background: var(--hover);
      color: var(--text);
    }

    .category-pill.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .category-pill .count {
        opacity: 0.7;
        font-size: 10px;
    }

    .app-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .icon-btn:hover {
      background: var(--hover);
      color: var(--text);
      border-color: var(--text-secondary);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Main Content */
    .main-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      position: relative;
    }

    .feed-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .feed-list {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 100px;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      padding-right: 44px; /* Space for checkbox */
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card:hover {
      border-color: var(--text-secondary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .card.focused {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--text);
      z-index: 10;
    }
    
    .card.selected {
      background: var(--selection);
      border-color: var(--text);
    }

    .card.archived {
      opacity: 0.5;
      filter: grayscale(100%);
    }

    /* Checkbox */
    .card-checkbox {
      position: absolute;
      right: 12px;
      top: 16px;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      color: transparent;
    }
    
    .card.selected .card-checkbox, .card-checkbox:hover {
        border-color: var(--text);
    }
    
    .card.selected .card-checkbox {
        background: var(--text);
        color: var(--bg);
    }
    
    .card-checkbox svg {
        width: 14px;
        height: 14px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .source-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .source-twitter { color: var(--twitter-color); background: rgba(29, 155, 240, 0.1); }
    .source-reddit { color: var(--reddit-color); background: rgba(255, 69, 0, 0.1); }
    .source-github { color: var(--github-color); background: rgba(128, 128, 128, 0.1); }
    
    [data-theme="dark"] .source-github { background: rgba(255, 255, 255, 0.1); }

    .card-author {
      font-weight: 500;
      color: var(--text);
    }

    .card-time {
      color: var(--text-tertiary);
    }

    .card-content {
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .card-content a {
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    
    .card-content img {
        display: none !important;
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .metric {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .metric svg {
      width: 14px;
      height: 14px;
    }

    .card-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .card:hover .card-actions, .card.focused .card-actions {
      opacity: 1;
    }

    .action-pill {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-secondary);
    }
    
    .action-pill:hover {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }

    /* Labels/Tags */
    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 99px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tag-mention { background: #e0e7ff; color: #4338ca; }
    .tag-bug { background: #fee2e2; color: #dc2626; }
    .tag-love { background: #dcfce7; color: #16a34a; }
    .tag-question { background: #fef3c7; color: #d97706; }

    [data-theme="dark"] .tag-mention { background: #312e81; color: #c7d2fe; }
    [data-theme="dark"] .tag-bug { background: #7f1d1d; color: #fecaca; }
    [data-theme="dark"] .tag-love { background: #14532d; color: #bbf7d0; }
    [data-theme="dark"] .tag-question { background: #78350f; color: #fde68a; }

    /* Bulk Actions Bar */
    .bulk-actions-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--text);
      color: var(--bg);
      padding: 8px 16px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 50;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .bulk-actions-bar.visible {
      transform: translateX(-50%) translateY(0);
    }
    
    .bulk-count {
      font-weight: 600;
      font-size: 13px;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 12px;
    }
    
    .bulk-btn {
      background: transparent;
      border: none;
      color: var(--bg);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .bulk-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .bulk-divider {
        width: 1px;
        height: 16px;
        background: rgba(255,255,255,0.2);
    }

    /* Modals & Overlays */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .overlay.open { display: flex; }

    .modal {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .modal h2 { font-size: 18px; margin-bottom: 16px; }
    .modal p { color: var(--text-secondary); margin-bottom: 20px; }
    
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      margin-bottom: 12px;
      font-family: inherit;
    }

    .modal button {
      width: 100%;
      padding: 10px;
      background: var(--text);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Utilities */
    .loading-state {
      padding: 40px;
      text-align: center;
      color: var(--text-secondary);
    }

    .status-toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text);
      color: var(--bg);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      transform: translateY(100px);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 200;
    }

    .status-toast.visible {
      transform: translateY(0);
    }
    
    .shortcuts-help {
        position: fixed;
        bottom: 24px;
        left: 24px;
        font-size: 12px;
        color: var(--text-tertiary);
        pointer-events: none;
        opacity: 0.6;
    }
    
    kbd {
        background: var(--border);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 10px;
        color: var(--text);
    }

    @media (max-width: 640px) {
      .app-header { 
          padding: 12px 16px; 
          height: auto; 
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
      }
      
      .mobile-top-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
      }
      
      .app-logo {
          font-size: 18px;
      }
      
      .app-filters { 
          overflow-x: auto; 
          max-width: 100%; 
          width: 100%;
          justify-content: flex-start;
          padding-bottom: 4px; /* Scrollbar space */
      }
      
      /* Hide scrollbar */
      .app-filters::-webkit-scrollbar {
          display: none;
      }
      
      .shortcuts-help { display: none; }
      .card { padding-left: 16px; padding-right: 16px; padding-top: 44px; }
      .card-checkbox { top: 16px; left: 16px; right: auto; }
      
      /* Mobile layout adjustments */
      .main-wrapper { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        overflow-x: auto;
        padding: 12px;
        height: auto;
        gap: 12px;
      }
      .category-item {
        min-width: auto;
        width: auto;
        white-space: nowrap;
        padding: 6px 12px;
        background: var(--card-bg);
        border: 1px solid var(--border);
      }
      .category-item.active {
        border-color: var(--text);
        background: var(--text);
        color: var(--bg);
      }
      .category-item.active i {
        stroke: var(--bg);
      }
      .category-item .count {
        margin-left: 8px;
      }
    }
  </style>
</head>
<body>

  <!-- Access Gate -->
  <div id="accessOverlay" class="overlay open">
    <div class="modal">
      <h2>üîê Access Required</h2>
      <p>Please enter your access token to view the feed.</p>
      <input type="password" id="tokenInput" placeholder="Access Token" />
      <div id="tokenError" style="color: var(--error); font-size: 12px; margin-bottom: 10px; display: none;">Invalid token</div>
      <button id="tokenSubmit">Enter</button>
    </div>
  </div>

  <!-- App Layout -->
  <header class="app-header">
    <div class="mobile-top-row">
        <div class="app-logo">
          <i data-lucide="zap" style="width: 18px; height: 18px;"></i>
          Factory Feed
        </div>
        
        <div class="app-controls">
          <button class="icon-btn" id="refreshBtn" title="Refresh (R)">
            <i data-lucide="refresh-cw"></i>
          </button>
          <button class="icon-btn" id="archiveToggleBtn" title="View Archived">
            <i data-lucide="archive"></i>
          </button>
          <button class="icon-btn" id="themeBtn" title="Toggle Theme">
            <i data-lucide="moon"></i>
          </button>
          <button class="icon-btn" id="settingsBtn" title="Settings">
            <i data-lucide="settings"></i>
          </button>
        </div>
    </div>
    
    <div class="app-filters">
      <button class="filter-tab active" data-filter="all">
        All <span class="badge" id="count-all">0</span>
      </button>
      <button class="filter-tab" data-filter="twitter">
        <i data-lucide="twitter" style="width: 12px; height: 12px;"></i> <span class="badge" id="count-twitter">0</span>
      </button>
      <button class="filter-tab" data-filter="reddit">
        <i data-lucide="message-square" style="width: 12px; height: 12px;"></i> <span class="badge" id="count-reddit">0</span>
      </button>
      <button class="filter-tab" data-filter="github">
        <i data-lucide="github" style="width: 12px; height: 12px;"></i> <span class="badge" id="count-github">0</span>
      </button>
    </div>
  </header>

  <div class="main-wrapper">
    <aside class="sidebar">
        <button class="category-item active" data-category="all">
            <i data-lucide="layers" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>All</span>
        </button>
        <button class="category-item" data-category="mention">
            <i data-lucide="at-sign" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>Mentions</span> <span class="count" id="cat-count-mention">0</span>
        </button>
        <button class="category-item" data-category="bug">
            <i data-lucide="bug" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>Bugs</span> <span class="count" id="cat-count-bug">0</span>
        </button>
        <button class="category-item" data-category="love">
            <i data-lucide="heart" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>Love</span> <span class="count" id="cat-count-love">0</span>
        </button>
        <button class="category-item" data-category="question">
            <i data-lucide="help-circle" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>Questions</span> <span class="count" id="cat-count-question">0</span>
        </button>
        <button class="category-item" data-category="other">
            <i data-lucide="archive" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            <span>Other</span> <span class="count" id="cat-count-other">0</span>
        </button>
    </aside>

    <main class="main-container">
      <div class="feed-container" id="scrollContainer">
        <div id="feedList" class="feed-list">
          <div class="loading-state">Loading feed...</div>
        </div>
      </div>
    </main>
  </div>
  
  <div class="bulk-actions-bar" id="bulkBar">
      <button class="bulk-btn" id="clearSelectionBtn" title="Clear Selection (Esc)">
          <i data-lucide="x"></i>
      </button>
      <div class="bulk-divider"></div>
      <div class="bulk-count" id="bulkCount">0</div>
      <button class="bulk-btn" id="archiveSelectedBtn" title="Archive Selected (E)">
          <i data-lucide="archive"></i> Archive
      </button>
      <button class="bulk-btn" id="selectAllBtn" title="Select All (Shift+A)">
          <i data-lucide="check-square"></i>
      </button>
  </div>
  
  <div class="shortcuts-help">
    <p><strong>J/K</strong> Nav ‚Ä¢ <strong>X</strong> Select ‚Ä¢ <strong>E</strong> Archive ‚Ä¢ <strong>Shift+A</strong> Select All</p>
  </div>

  <div id="statusToast" class="status-toast">Action completed</div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="overlay">
    <div class="modal" style="max-width: 600px;">
      <h2>Configuration</h2>
      <textarea id="configInput" style="height: 300px; font-family: monospace; font-size: 12px;"></textarea>
      <div style="display: flex; gap: 10px;">
        <button id="saveConfigBtn">Save Changes</button>
        <button id="closeSettingsBtn" style="background: transparent; color: var(--text); border: 1px solid var(--border);">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Config & Constants
    const ACCESS_TOKEN_HASH = '63fc567c78f3056569ecfdf2ba53cf1955ff86d34d2ab05a3683899e5c642dfe';
    const STORAGE_KEYS = {
      TOKEN: 'factoryAccessToken',
      ARCHIVED: 'factoryArchivedIds',
      CONFIG: 'factoryFeedConfig',
      THEME: 'theme'
    };

    // State
    let state = {
      items: [],
      filteredItems: [],
      archivedIds: new Set(),
      selectedIds: new Set(),
      activeFilter: 'all', // all, twitter, reddit, github
      activeCategory: 'all', // all, mention, bug, love, question, other
      showArchived: false,
      focusedId: null,
      config: {}
    };

    // DOM Elements
    const elements = {
      feedList: document.getElementById('feedList'),
      accessOverlay: document.getElementById('accessOverlay'),
      tokenInput: document.getElementById('tokenInput'),
      tokenSubmit: document.getElementById('tokenSubmit'),
      tokenError: document.getElementById('tokenError'),
      filterTabs: document.querySelectorAll('.filter-tab'),
      categoryItems: document.querySelectorAll('.category-item'),
      bulkBar: document.getElementById('bulkBar'),
      bulkCount: document.getElementById('bulkCount'),
      counts: {
        all: document.getElementById('count-all'),
        twitter: document.getElementById('count-twitter'),
        reddit: document.getElementById('count-reddit'),
        github: document.getElementById('count-github')
      },
      catCounts: {
          mention: document.getElementById('cat-count-mention'),
          bug: document.getElementById('cat-count-bug'),
          love: document.getElementById('cat-count-love'),
          question: document.getElementById('cat-count-question'),
          other: document.getElementById('cat-count-other')
      },
      toast: document.getElementById('statusToast'),
      settingsModal: document.getElementById('settingsModal'),
      configInput: document.getElementById('configInput'),
      scrollContainer: document.getElementById('scrollContainer')
    };

    // --- Initialization ---
    async function init() {
      loadPersistedState();
      setupTheme();
      setupEventListeners();
      
      if (await checkAccess()) {
        startApp();
      }
    }

    function loadPersistedState() {
      try {
        const archived = JSON.parse(localStorage.getItem(STORAGE_KEYS.ARCHIVED) || '[]');
        state.archivedIds = new Set(archived);
      } catch (e) { console.error(e); }
      
      state.config = getConfig();
    }

    async function startApp() {
      elements.accessOverlay.classList.remove('open');
      await fetchFeed();
      setInterval(fetchFeed, 60000);
    }

    // --- Auth ---
    async function hashToken(token) {
      const encoder = new TextEncoder();
      const data = encoder.encode(token);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function checkAccess() {
      const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
      if (!token) return false;
      return (await hashToken(token)) === ACCESS_TOKEN_HASH;
    }

    elements.tokenSubmit.addEventListener('click', async () => {
      const token = elements.tokenInput.value.trim();
      if ((await hashToken(token)) === ACCESS_TOKEN_HASH) {
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        startApp();
      } else {
        elements.tokenError.style.display = 'block';
      }
    });

    elements.tokenInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') elements.tokenSubmit.click();
    });

    // --- Data ---
    async function fetchFeed() {
      try {
        const res = await fetch('./data/feed.json');
        if (!res.ok) throw new Error('Failed to fetch');
        state.items = await res.json();
        
        // Sort by date desc
        state.items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        render();
      } catch (err) {
        console.error(err);
        showToast('Failed to refresh feed', 'error');
      }
    }

    function getConfig() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.CONFIG) || '{}') || {};
      } catch { return {}; }
    }

    // --- Rendering ---
    function render() {
      // Filter items
      state.filteredItems = state.items.filter(item => {
        const isArchived = state.archivedIds.has(item.id);
        if (state.showArchived !== isArchived) return false;
        
        // Source filter
        if (state.activeFilter !== 'all' && item.source !== state.activeFilter) return false;
        
        // Category filter
        if (state.activeCategory !== 'all') {
            const cat = item.category || item.classification?.label || 'other';
            if (cat !== state.activeCategory) return false;
        }
        
        return true;
      });

      // Update counts
      updateCounts();
      updateBulkBar();

      // Render list
      if (state.filteredItems.length === 0) {
        elements.feedList.innerHTML = '<div class="loading-state">No items found</div>';
        return;
      }

      const html = state.filteredItems.map(item => createCardHTML(item)).join('');
      elements.feedList.innerHTML = html;
      
      // Restore focus
      if (state.focusedId) {
        const el = document.getElementById(`card-${state.focusedId}`);
        if (el) {
            el.classList.add('focused');
        } else {
            state.focusedId = null; 
        }
      }
      
      lucide.createIcons();
      
      // Listeners
      attachCardListeners();
    }
    
    function attachCardListeners() {
        document.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', (e) => {
             // Avoid double actions if clicking interactive elements
             if (e.target.closest('.action-pill')) return;
             if (e.target.closest('.card-checkbox')) return;
             if (e.target.tagName === 'A') return;
             
             const id = card.dataset.id;
             focusCard(id);
             
             // Click body now opens the URL
             const url = card.dataset.url;
             if (url) window.open(url, '_blank');
          });
      });
      
      document.querySelectorAll('.card-checkbox').forEach(box => {
          box.addEventListener('click', (e) => {
              e.stopPropagation();
              const id = box.dataset.id;
              toggleSelection(id);
          });
      });
      
      document.querySelectorAll('.action-archive').forEach(btn => {
          btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const id = btn.dataset.id;
              toggleArchive(id);
          });
      });

      document.querySelectorAll('.action-open').forEach(btn => {
          btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const url = btn.dataset.url;
              if (url) window.open(url, '_blank');
          });
      });
    }

    function createCardHTML(item) {
      const isArchived = state.archivedIds.has(item.id);
      const isSelected = state.selectedIds.has(item.id);
      const date = new Date(item.timestamp);
      const timeAgo = getTimeAgo(date);
      const category = item.category || item.classification?.label;
      
      let sourceIcon = 'circle';
      if (item.source === 'twitter') sourceIcon = 'twitter';
      if (item.source === 'reddit') sourceIcon = 'message-square';
      if (item.source === 'github') sourceIcon = 'github';

      return `
        <div class="card ${isArchived ? 'archived' : ''} ${isSelected ? 'selected' : ''}" 
             id="card-${item.id}" 
             data-id="${item.id}" 
             data-url="${item.url}">
          
          <div class="card-checkbox" data-id="${item.id}">
              ${isSelected ? '<i data-lucide="check"></i>' : ''}
          </div>

          <div class="card-header">
            <div class="card-meta">
              <span class="source-badge source-${item.source}" title="${item.source}">
                <i data-lucide="${sourceIcon}" style="width: 12px; height: 12px;"></i>
              </span>
              <span class="card-author">${item.author}</span>
              <span class="card-time">‚Ä¢ ${timeAgo}</span>
              ${category ? `<span class="tag tag-${category}"><i data-lucide="${getCategoryIcon(category)}" style="width: 10px; height: 10px;"></i></span>` : ''}
            </div>
            <div class="card-actions">
              <!-- Hidden by CSS as requested, but kept for logic if needed later -->
              <button class="action-pill action-open" data-id="${item.id}" data-url="${item.url}" title="Open Link (Enter)">Open</button>
              <button class="action-pill action-archive" data-id="${item.id}">${isArchived ? 'Unarchive' : 'Archive'}</button>
            </div>
          </div>
          
          <div class="card-content">${formatContent(item.content)}</div>
          
          <div class="card-footer">
             ${item.metadata?.likes ? `<span class="metric"><i data-lucide="heart"></i> ${formatNumber(item.metadata.likes)}</span>` : ''}
             ${item.metadata?.retweets ? `<span class="metric"><i data-lucide="repeat"></i> ${formatNumber(item.metadata.retweets)}</span>` : ''}
             ${item.metadata?.replies ? `<span class="metric"><i data-lucide="message-circle"></i> ${formatNumber(item.metadata.replies)}</span>` : ''}
             ${item.metadata?.stars ? `<span class="metric"><i data-lucide="star"></i> ${formatNumber(item.metadata.stars)}</span>` : ''}
          </div>
        </div>
      `;
    }
    
    function updateCounts() {
        const counts = { all: 0, twitter: 0, reddit: 0, github: 0 };
        const catCounts = { mention: 0, bug: 0, love: 0, question: 0, other: 0 };
        
        state.items.forEach(item => {
            if (state.archivedIds.has(item.id)) return;
            
            // Source counts
            counts.all++;
            if (counts[item.source] !== undefined) counts[item.source]++;
            
            // Category counts (filtered by active source)
            if (state.activeFilter === 'all' || item.source === state.activeFilter) {
                 const cat = item.category || item.classification?.label || 'other';
                 if (catCounts[cat] !== undefined) catCounts[cat]++;
                 else catCounts.other++;
            }
        });
        
        for (const key in counts) {
            if (elements.counts[key]) elements.counts[key].textContent = counts[key];
        }
        
        for (const key in catCounts) {
            if (elements.catCounts[key]) elements.catCounts[key].textContent = catCounts[key];
        }
    }
    
    function updateBulkBar() {
        const count = state.selectedIds.size;
        if (count > 0) {
            elements.bulkBar.classList.add('visible');
            elements.bulkCount.textContent = `${count}`;
        } else {
            elements.bulkBar.classList.remove('visible');
        }
    }

    function getCategoryIcon(category) {
        switch(category) {
            case 'mention': return 'at-sign';
            case 'bug': return 'bug';
            case 'love': return 'heart';
            case 'question': return 'help-circle';
            default: return 'archive';
        }
    }

    // --- Actions ---
    function toggleSelection(id) {
        if (state.selectedIds.has(id)) {
            state.selectedIds.delete(id);
        } else {
            state.selectedIds.add(id);
        }
        render();
    }
    
    function selectAllVisible() {
        state.filteredItems.forEach(item => {
            state.selectedIds.add(item.id);
        });
        render();
    }
    
    function clearSelection() {
        state.selectedIds.clear();
        render();
    }
    
    function archiveSelected() {
        const count = state.selectedIds.size;
        if (count === 0) return;
        
        state.selectedIds.forEach(id => {
            state.archivedIds.add(id);
        });
        state.selectedIds.clear();
        localStorage.setItem(STORAGE_KEYS.ARCHIVED, JSON.stringify([...state.archivedIds]));
        
        showToast(`Archived ${count} items`);
        render();
    }

    function toggleArchive(id) {
      if (state.archivedIds.has(id)) {
        state.archivedIds.delete(id);
        showToast('Post unarchived');
      } else {
        state.archivedIds.add(id);
        showToast('Post archived');
        if (state.focusedId === id) moveFocus(1);
      }
      
      localStorage.setItem(STORAGE_KEYS.ARCHIVED, JSON.stringify([...state.archivedIds]));
      render();
    }

    function focusCard(id) {
       if (state.focusedId) {
           document.getElementById(`card-${state.focusedId}`)?.classList.remove('focused');
       }
       state.focusedId = id;
       const el = document.getElementById(`card-${id}`);
       if (el) {
           el.classList.add('focused');
           el.scrollIntoView({ behavior: 'smooth', block: 'center' });
       }
    }

    function moveFocus(direction) {
        if (state.filteredItems.length === 0) return;
        
        let currentIndex = state.filteredItems.findIndex(i => i.id === state.focusedId);
        if (currentIndex === -1) {
            currentIndex = 0;
        } else {
            currentIndex += direction;
        }
        
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= state.filteredItems.length) currentIndex = state.filteredItems.length - 1;
        
        const item = state.filteredItems[currentIndex];
        if (item) focusCard(item.id);
    }

    function openFocused() {
        if (!state.focusedId) return;
        const item = state.items.find(i => i.id === state.focusedId);
        if (item && item.url) window.open(item.url, '_blank');
    }

    // --- Helpers ---
    function formatContent(text) {
       if (!text) return '';
       return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" onClick="event.stopPropagation()">$1</a>');
    }

    function formatNumber(num) {
        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
        return num;
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h`;
        const days = Math.floor(hours / 24);
        return `${days}d`;
    }

    function showToast(msg, type = 'info') {
        elements.toast.textContent = msg;
        elements.toast.classList.add('visible');
        setTimeout(() => elements.toast.classList.remove('visible'), 3000);
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        // Filter Tabs
        elements.filterTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                elements.filterTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.activeFilter = tab.dataset.filter;
                state.selectedIds.clear();
                render();
                elements.scrollContainer.scrollTop = 0;
            });
        });
        
        // Category Items
        elements.categoryItems.forEach(item => {
            item.addEventListener('click', () => {
                elements.categoryItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                state.activeCategory = item.dataset.category;
                state.selectedIds.clear();
                render();
                elements.scrollContainer.scrollTop = 0;
            });
        });
        
        // Bulk Actions
        document.getElementById('archiveSelectedBtn').addEventListener('click', archiveSelected);
        document.getElementById('selectAllBtn').addEventListener('click', selectAllVisible);
        document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);

        // Controls
        document.getElementById('refreshBtn').addEventListener('click', fetchFeed);
        
        document.getElementById('archiveToggleBtn').addEventListener('click', () => {
            state.showArchived = !state.showArchived;
            document.getElementById('archiveToggleBtn').classList.toggle('active');
            render();
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            elements.configInput.value = JSON.stringify(state.config, null, 2);
            elements.settingsModal.classList.add('open');
        });

        document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            elements.settingsModal.classList.remove('open');
        });

        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            try {
                const newConfig = JSON.parse(elements.configInput.value);
                localStorage.setItem(STORAGE_KEYS.CONFIG, JSON.stringify(newConfig));
                state.config = newConfig;
                elements.settingsModal.classList.remove('open');
                showToast('Configuration saved');
            } catch {
                alert('Invalid JSON');
            }
        });

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key.toLowerCase()) {
                case 'j': moveFocus(1); break;
                case 'k': moveFocus(-1); break;
                case 'e': 
                    if (state.selectedIds.size > 0) {
                        archiveSelected();
                    } else if (state.focusedId) {
                        toggleArchive(state.focusedId); 
                    }
                    break;
                case 'x':
                    if (state.focusedId) toggleSelection(state.focusedId);
                    break;
                case 'a':
                    if (e.shiftKey) {
                        e.preventDefault();
                        selectAllVisible();
                    }
                    break;
                case 'escape':
                    clearSelection();
                    break;
                case 'enter':
                    openFocused();
                    break;
                case 'r':
                    fetchFeed();
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    moveFocus(1);
                    break;
                case 'arrowup':
                    e.preventDefault();
                    moveFocus(-1);
                    break;
            }
        });
    }

    function setupTheme() {
        const themeBtn = document.getElementById('themeBtn');
        const stored = localStorage.getItem(STORAGE_KEYS.THEME);
        if (stored === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        themeBtn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem(STORAGE_KEYS.THEME, next);
            
            const icon = next === 'dark' ? 'sun' : 'moon';
            themeBtn.innerHTML = `<i data-lucide="${icon}"></i>`;
            lucide.createIcons();
        });
    }

    init();
  </script>
</body>
</html>
